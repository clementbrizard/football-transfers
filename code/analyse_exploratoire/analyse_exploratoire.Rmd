---
title: "Analyse exploratoire"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r load data, echo = FALSE}
transfers <- read.csv("../../data/top250-00-19.csv", header = T, na.strings = c("NA", "0"))
```

# Taille du dataset
## Nombre de transferts enregistrés
```{r}
nrow(transfers)
```

Le dataset répertorie donc 4700 transferts. Il est sensé contenir les 250 transferts les plus élevés pour chaque saison des dix-neuf dernières saisons :
```{r}
length(unique(transfers$Season))
```
Or : 
```{r}
19 * 250
```
Nous ne disposons donc pas exactement de 250 transferts par saison :
```{r}
freq <- table(transfers$Season)
sort(freq[freq != 250])
```
Il manque des transferts pour 15 saisons sur 19 mais ce n'est jamais plus de 8 transferts sur 250, ce qui ne devrait pas fausser les mesures de l'influence de la saison que l'on pourra faire par la suite.

## Nombre de prédicteurs
```{r}
ncol(transfers)
colnames(transfers)
```


# Nettoyage des données
## Vérification des classes des prédicteurs
```{r}
sapply(transfers, class)
```

On convertit la variable "Name" au type `character`, utilisé en R pour représenter les `string`. On pourrait dire que le nom est un facteur mais la variable prend tellement de valeurs que cela semble plus pertinent d'en faire un type `character`. On ne le fait pas pour les équipes et les ligues, qui prennent moins de valeurs différentes et peuvent a priori avoir une influence sur le prix des joueurs, contrairement à leur nom.
```{r}
transfers$Name <- as.character(transfers$Name)
class(transfers$Name)
```

On convertit la variable "Season" en facteur ordonné :
```{r}
# we use the already alphabetical order of seasons
transfers$Season <- as.ordered(transfers$Season)
```


## Vérification cohérence des données
### Valeurs manquantes ou nulles
```{r}
summary(transfers)
```
Seule la colonne "Market_value" contient des valeurs nulles, à raison de 1260 sur 4700 soit 27 %.
```{r}
# extract rows where Market_value is na
null_market_value <- transfers[is.na(transfers$Market_value) == T,]

# make a contingency table by season
cont <- table(null_market_value$Season)
cont

# proportion of the first five seasons
sum(cont[1:5])
sum(cont[1:5]) / sum(cont)
```
Les cinq premières saisons concentrent l'essentiel des valeurs manquantes.


## Valeurs incohérentes
On s'intéresse aux ligues :
```{r}
levels(transfers$League_from)
```
Les 40 premières valeurs sont des valeurs de pays. Les autres valeurs sont bien des ligues. On regarde combien de transferts ont une valeur de pays et non de ligue dans une des deux colonnes de ligues :
```{r}
pays_League_from <- levels(transfers$League_from)[1:40]
pays_League_to <- levels(transfers$League_to)[1:24]
pays <- unique(c(pays_League_from, pays_League_to))
nrow(subset(transfers, League_from %in% pays | League_to %in% pays))
```
444 transferts sur 4699 sont concernés, soit presque 10 %. Nous décidons néanmoins de nous en débarrasser :
```{r}
transfers <- subset(transfers, !(League_from %in% pays | League_to %in% pays))
nrow(transfers)
```

# Synthèse
Nous avons changé le type de la conomme "Name", remaqrqué que 27 % des valeurs de la colonne "Market_value étaient manquantes, principalement sur les cinq premières saisons, supprimé l'unique transfert où l'âge du joueur était nul, et supprimé les 10 % de transferts donc la colonne "League_from" ou "League_to" avait pour valeur un pays.

# Première étude des données
```{r}
length(levels(transfers$Team_from))
length(levels(transfers$Team_to))
```
Les 4699 transferts se répartissent en 570 clubs vendeurs et 325 clubs acheteurs. Cette différence pourraiy s'expliquer par le fait que certains clubs vendent cher des joueurs dont ils ont fait augmenter la valeur après les avoir acheté à faible prix. Il y a une concentration des mêmes clubs acheteurs dans les transferts les plus élevés.
